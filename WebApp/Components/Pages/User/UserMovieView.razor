@using Frontend.DTOs.Movie
@using Frontend.DTOs.Review
@using Frontend.Services
@inject MovieClient MovieClient
@inject ReviewClient ReviewClient
@inject CustomAuthService AuthService
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedSessionStorage SessionStorage
@inject IJSRuntime JS

<link href="DetailedMovieView.css" rel="stylesheet" />

@if (movie == null)
{
    <div class="loading">Loading movie details...</div>
}
else
{
    <div class="movie-detail-container">
        <div class="movie-header">
            <button class="back-btn" @onclick="GoBack">← Back</button>
        </div>

        <div class="movie-detail-content">
            <div class="movie-poster">
                <img src="@movie.PosterUrl" alt="@movie.Title" />
            </div>

            <div class="movie-info">
                <h1 class="movie-title">@movie.Title</h1>
                <div class="movie-meta">
                    <div class="stars">@((MarkupString)RenderStars(movie.Rating))</div>
                    <span class="rating-value">@movie.Rating.ToString("0.0")/10</span>
                    <span class="runtime">@movie.RunTime min</span>
                    <span class="release-year">@movie.ReleaseDate</span>
                </div>

                <div class="info-section">
                    <h3>Genres</h3>
                    <div class="genre-tags">
                        @foreach (var genre in movie.Genres)
                        {
                            <span class="genre-tag">@genre</span>
                        }
                    </div>
                </div>

                <div class="info-section">
                    <h3>Directors</h3>
                    <p>@string.Join(", ", movie.Directors)</p>
                </div>

                <div class="info-section">
                    <h3>Cast</h3>
                    <p>@string.Join(", ", movie.Actors)</p>
                </div>

                <div class="info-section">
                    <h3>Synopsis</h3>
                    <p class="description">@movie.Description</p>
                </div>

                <div class="info-section">
                    <h3>Reviews</h3>
                    @if (userReview != null)
                    {
                        <div class="user-review highlight">
                            <strong>Your Review</strong>
                            <div class="stars">@((MarkupString)RenderStars(userReview.Rating))</div>
                            <p>@userReview.Text</p>
                        </div>
                    }
                    <div class="review-list">
                        @foreach (var review in otherReviews)
                        {
                            <div class="review-item">
                                <strong>@review.UserId</strong>
                                <div class="stars">@((MarkupString)RenderStars(review.Rating))</div>
                                <p>@review.Text</p>
                            </div>
                        }
                    </div>
                    <div class="review-form">
                        <h4>@(userReview == null ? "Write a Review" : "Update Your Review")</h4>
                        <input type="number" min="1" max="10" step="1" @bind="reviewRating" class="review-rating-input" />
                        <textarea @bind="reviewComment" placeholder="Your review..." rows="3" class="review-comment-input"></textarea>
                        <button class="save-btn" @onclick="SubmitReview">
                            @(userReview == null ? "Submit Review" : "Update Review")
                        </button>
                        @if (!string.IsNullOrEmpty(reviewError))
                        {
                            <div class="validation-message">@reviewError</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private MovieDto? movie;
    private List<ReviewDto> reviews = new();
    private ReviewDto? userReview;
    private List<ReviewDto> otherReviews = new();
    private int? userId;
    private string? userName;
    private int reviewRating = 10;
    private string reviewComment = "";
    private string? reviewError;

    protected override async Task OnInitializedAsync()
    {
        await LoadMovie();
        await LoadUserInfo();
        await LoadReviews();
    }

    private async Task LoadMovie()
    {
        movie = await MovieClient.GetMovieByIdAsync(Id);
    }

    // Only one LoadUserInfo method, using ClaimTypes.NameIdentifier
    private async Task LoadUserInfo()
    {
        var result = await SessionStorage.GetAsync<string>("authToken");
        if (result.Success && !string.IsNullOrEmpty(result.Value))
        {
            var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
            var jwt = handler.ReadJwtToken(result.Value);
            var userIdClaim = jwt.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            userName = jwt.Claims.FirstOrDefault(c => c.Type == "username")?.Value ?? "You";
            userId = int.TryParse(userIdClaim, out var uid) && uid > 0 ? uid : null;
        }
    }

    private async Task LoadReviews()
    {
        var result = await ReviewClient.GetReviewsByMovieAsync(Id);
        reviews = result?.ToList() ?? new();
        userReview = userId.HasValue ? reviews.FirstOrDefault(r => r.UserId == userId.Value) : null;
        otherReviews = userId.HasValue ? reviews.Where(r => r.UserId != userId.Value).ToList() : reviews;
        if (userReview != null)
        {
            reviewRating = (int)userReview.Rating;
            reviewComment = userReview.Text;
        }
    }

    private async Task SubmitReview()
    {
        reviewError = null;
        if (!userId.HasValue)
        {
            reviewError = "User not authenticated.";
            return;
        }
        if (reviewRating < 1 || reviewRating > 10 || string.IsNullOrWhiteSpace(reviewComment))
        {
            reviewError = "Please enter a rating (1-10) and a comment.";
            return;
        }

        bool success;
        if (userReview == null)
        {
            var dto = new CreateReviewDto
            {
                MovieId = Id,
                UserId = userId.Value,
                Text = reviewComment,
                Rating = reviewRating
            };
            var created = await ReviewClient.CreateReviewAsync(dto);
            success = created != null;
        }
        else
        {
            var dto = new UpdateReviewDto
            {
                Text = reviewComment,
                Rating = reviewRating
            };
            var updated = await ReviewClient.UpdateReviewAsync(userReview.Id, dto);
            success = updated != null;
        }

        if (success)
        {
            await LoadReviews();
        }
        else
        {
            reviewError = "Failed to submit review. Please try again.";
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/movies");
    }

    private string RenderStars(double rating)
    {
        int fullStars = (int)(rating / 2);
        bool halfStar = (rating % 2) >= 1;
        int emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

        string stars = string.Concat(Enumerable.Repeat("★", fullStars)) +
                      (halfStar ? "½" : "") +
                      string.Concat(Enumerable.Repeat("☆", emptyStars));

        return stars;
    }
}